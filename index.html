<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lista de Compras</title>
    
    <!-- --- CONFIGURAÇÕES PWA --- -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Compras">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/512/shopping-cart.png">
    <link rel="manifest" href="manifest.json">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React e ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            background-color: #f3f4f6;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        input {
            -webkit-user-select: text;
            user-select: text;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .item-row:active { background-color: #eff6ff; }
    </style>
</head>
<body>

<div id="root">
    <div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;color:#666;font-family:sans-serif;gap:15px;">
        <div style="width:40px;height:40px;border:3px solid #ddd;border-top-color:#2563eb;border-radius:50%;animation:spin 1s linear infinite;"></div>
        <div>Carregando...</div>
    </div>
    <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
</div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- ÍCONES ---
    const IconCart = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-16 h-16 mb-4 text-blue-200"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>;
    const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6"><path d="M5 12h14"/><path d="M12 5v14"/></svg>;
    const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
    const IconSave = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
    const IconX = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;

    function App() {
        const [items, setItems] = useState([]);
        
        // Estado para novo item (barra inferior)
        const [newName, setNewName] = useState('');
        const [newPrice, setNewPrice] = useState('');
        const [newQty, setNewQty] = useState('');

        // Estado para edição (Modal)
        // Se for null, o modal está fechado. Se tiver objeto, modal aberto com dados.
        const [editingItem, setEditingItem] = useState(null);

        const nameInputRef = useRef(null);

        // Carregar
        useEffect(() => {
            try {
                const savedItems = localStorage.getItem('myShoppingList');
                if (savedItems) setItems(JSON.parse(savedItems));
            } catch (e) { console.error(e); }
        }, []);

        // Salvar
        useEffect(() => {
            localStorage.setItem('myShoppingList', JSON.stringify(items));
        }, [items]);

        // Adicionar Novo Item
        const handleAddItem = (e) => {
            e.preventDefault();
            if (!newName) return;
            
            const item = {
                id: Date.now(),
                name: newName.trim(),
                price: newPrice ? parseFloat(newPrice) : 0,
                qty: newQty ? parseFloat(newQty) : 1
            };

            setItems([...items, item]);
            setNewName(''); setNewPrice(''); setNewQty('');
            if(nameInputRef.current) nameInputRef.current.focus();
        };

        // Abrir Modal de Edição
        const handleRowClick = (item) => {
            // Fecha teclado para evitar bugs visuais
            if (document.activeElement instanceof HTMLElement) document.activeElement.blur();
            // Cria uma cópia do item para editar sem alterar a lista principal ainda
            setEditingItem({ ...item });
        };

        // Salvar Edição
        const handleSaveEdit = () => {
            if (!editingItem || !editingItem.name) return;

            setItems(items.map(item => 
                item.id === editingItem.id ? editingItem : item
            ));
            setEditingItem(null); // Fecha modal
        };

        // Remover Item (Dentro do Modal)
        const handleDelete = () => {
            if (!editingItem) return;
            setItems(items.filter(item => item.id !== editingItem.id));
            setEditingItem(null); // Fecha modal
        };

        const totalSum = items.reduce((acc, item) => acc + (item.price * item.qty), 0);

        return (
            <div className="flex flex-col h-screen max-w-md mx-auto bg-white shadow-2xl overflow-hidden relative">
                
                {/* Cabeçalho */}
                <header className="bg-blue-600 text-white p-4 shadow-md z-10 flex justify-between items-center pt-safe-top">
                    <h1 className="text-xl font-bold tracking-tight">Minha Lista</h1>
                    <div className="text-blue-100 text-sm font-medium bg-blue-700 px-2 py-1 rounded-md">
                        {items.length} itens
                    </div>
                </header>

                {/* Lista */}
                <div className="flex-1 overflow-y-auto pb-40 bg-gray-50">
                    {items.length === 0 ? (
                        <div className="flex flex-col items-center justify-center h-full text-gray-400 p-8 text-center">
                            <IconCart />
                            <p className="text-lg font-medium text-gray-500">Sua lista está vazia</p>
                        </div>
                    ) : (
                        <table className="w-full text-left border-collapse">
                            <thead className="bg-white text-gray-500 text-xs uppercase sticky top-0 shadow-sm z-0">
                                <tr>
                                    <th className="p-3 pl-4 font-semibold">Item</th>
                                    <th className="p-3 font-semibold text-right w-20">R$ Un.</th>
                                    <th className="p-3 font-semibold text-center w-14">Qtd</th>
                                    <th className="p-3 pr-4 font-semibold text-right w-24">Total</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200 bg-white">
                                {items.map((item) => (
                                    <tr 
                                        key={item.id} 
                                        onClick={() => handleRowClick(item)}
                                        className="item-row cursor-pointer transition-colors duration-150"
                                        role="button"
                                        tabIndex="0"
                                    >
                                        <td className="p-3 pl-4 font-medium text-gray-800 break-words">{item.name}</td>
                                        <td className="p-3 text-right text-gray-600 text-sm">
                                            {item.price > 0 ? item.price.toFixed(2) : '-'}
                                        </td>
                                        <td className="p-3 text-center text-gray-600 text-sm font-medium bg-gray-50 rounded-sm mx-1">
                                            {item.qty}
                                        </td>
                                        <td className="p-3 pr-4 text-right font-bold text-blue-600 tabular-nums">
                                            {(item.price * item.qty).toFixed(2)}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </div>

                {/* Formulário Fixo (Adicionar) */}
                <div className="absolute bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-20 pb-safe-bottom shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                    <div className="p-3 bg-gray-50">
                        <form onSubmit={handleAddItem} className="flex flex-col gap-2">
                            <input 
                                ref={nameInputRef}
                                type="text" 
                                placeholder="Nome do item..." 
                                className="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:border-blue-500 text-base"
                                value={newName}
                                onChange={(e) => setNewName(e.target.value)}
                                autoComplete="off"
                            />
                            <div className="flex gap-2">
                                <div className="relative flex-1">
                                    <span className="absolute left-3 top-3 text-gray-400 text-sm font-medium">R$</span>
                                    <input 
                                        type="number" inputMode="decimal" step="0.01" placeholder="0.00" 
                                        className="w-full p-3 pl-9 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:border-blue-500 text-base"
                                        value={newPrice}
                                        onChange={(e) => setNewPrice(e.target.value)}
                                    />
                                </div>
                                <input 
                                    type="number" inputMode="decimal" step="0.001" placeholder="Qtd" 
                                    className="w-20 p-3 border border-gray-300 rounded-lg shadow-sm text-center focus:outline-none focus:border-blue-500 text-base"
                                    value={newQty}
                                    onChange={(e) => setNewQty(e.target.value)}
                                />
                                <button type="submit" className="bg-blue-600 text-white p-3 rounded-lg font-bold w-14 flex items-center justify-center shadow-md active:scale-95 transition-all">
                                    <IconPlus />
                                </button>
                            </div>
                        </form>
                    </div>

                    <div className="bg-gray-900 text-white p-4 flex justify-between items-center">
                        <div className="flex flex-col">
                            <span className="text-gray-400 text-xs uppercase font-bold">Total Geral</span>
                        </div>
                        <span className="text-3xl font-bold text-green-400 tracking-tight tabular-nums">
                            <span className="text-lg align-top mr-1 opacity-70">R$</span>
                            {totalSum.toFixed(2)}
                        </span>
                    </div>
                </div>

                {/* MODAL DE EDIÇÃO */}
                {editingItem && (
                    <div 
                        className="fixed inset-0 z-50 flex items-end sm:items-center justify-center"
                        style={{ backgroundColor: 'rgba(0,0,0,0.8)' }}
                        onClick={() => setEditingItem(null)} // Clicar fora fecha
                    >
                        <div 
                            className="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-xl shadow-2xl p-5 m-0 sm:m-4 flex flex-col gap-4" 
                            onClick={(e) => e.stopPropagation()} // Clicar dentro não fecha
                        >
                            {/* Título e Fechar */}
                            <div className="flex justify-between items-center border-b pb-3 border-gray-100">
                                <h3 className="text-lg font-bold text-gray-800">Editar Item</h3>
                                <button onClick={() => setEditingItem(null)} className="text-gray-400 p-1 rounded-full hover:bg-gray-100">
                                    <IconX />
                                </button>
                            </div>
                            
                            {/* Campos de Edição */}
                            <div className="flex flex-col gap-3">
                                <div>
                                    <label className="text-xs font-semibold text-gray-500 uppercase">Nome</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-lg"
                                        value={editingItem.name}
                                        onChange={(e) => setEditingItem({...editingItem, name: e.target.value})}
                                    />
                                </div>
                                
                                <div className="flex gap-3">
                                    <div className="flex-1">
                                        <label className="text-xs font-semibold text-gray-500 uppercase">Preço (Un.)</label>
                                        <div className="relative">
                                            <span className="absolute left-3 top-3.5 text-gray-400">R$</span>
                                            <input 
                                                type="number" inputMode="decimal" step="0.01"
                                                className="w-full p-3 pl-9 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-lg"
                                                value={editingItem.price}
                                                onChange={(e) => setEditingItem({...editingItem, price: e.target.value ? parseFloat(e.target.value) : ''})}
                                            />
                                        </div>
                                    </div>
                                    <div className="w-24">
                                        <label className="text-xs font-semibold text-gray-500 uppercase">Qtd</label>
                                        <input 
                                            type="number" inputMode="decimal" step="0.001"
                                            className="w-full p-3 border border-gray-300 rounded-lg text-center focus:border-blue-500 focus:outline-none text-lg"
                                            value={editingItem.qty}
                                            onChange={(e) => setEditingItem({...editingItem, qty: e.target.value ? parseFloat(e.target.value) : ''})}
                                        />
                                    </div>
                                </div>
                            </div>
                            
                            {/* Botões de Ação */}
                            <div className="flex gap-3 mt-2 pt-3 border-t border-gray-100">
                                <button 
                                    onClick={handleDelete}
                                    className="flex-1 py-3 bg-red-50 text-red-600 border border-red-100 rounded-xl font-bold flex justify-center items-center gap-2 hover:bg-red-100 transition-colors"
                                >
                                    <IconTrash /> Remover
                                </button>
                                <button 
                                    onClick={handleSaveEdit}
                                    className="flex-[2] py-3 bg-blue-600 text-white rounded-xl font-bold flex justify-center items-center gap-2 shadow-md hover:bg-blue-700 active:scale-95 transition-all"
                                >
                                    <IconSave /> Salvar
                                </button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .catch(err => console.log('Service Worker não registrado (normal em preview):', err));
        });
    }

</script>
</body>
</html>
